<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Chat With AI</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #000000;
      --bubble-ai: #f1f1f1;
      --bubble-user: #d1e7dd;
    }

    body.dark {
      --bg: #1a1a1a;
      --fg: #ffffff;
      --bubble-ai: #2a2a2a;
      --bubble-user: #3a3a3a;
    }

    * {
      transition: all 0.3s ease;
    }

    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: var(--bubble-ai);
    }

    .toolbar button {
      padding: 5px 10px;
      border: 1px solid var(--fg);
      background: none;
      color: var(--fg);
      border-radius: 5px;
      cursor: pointer;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      gap: 10px;
      max-width: 80%;
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message .bubble {
      padding: 10px;
      border-radius: 15px;
      background: var(--bubble-ai);
      word-break: break-word;
      white-space: pre-wrap;
    }

    .message.user .bubble {
      background: var(--bubble-user);
    }

    .message img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 22px;
      color: white;
      flex-shrink: 0;
      user-select: none;
      box-shadow: 0 0 4px rgba(0,0,0,0.2);
    }

    .input-area {
      display: flex;
      justify-content: center;
      padding: 10px;
      background: var(--bg);
      border-top: 1px solid #ccc;
    }

    .input-wrapper {
      width: 1000px;
      display: flex;
    }

    .input-area textarea {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
      background: var(--bubble-ai);
      color: var(--fg);
      resize: vertical;
      min-height: 40px;
      max-height: 200px;
    }

    .input-area button {
      margin-left: 10px;
      padding: 10px 15px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    .typing {
      display: flex;
      gap: 5px;
    }

    .typing span {
      width: 6px;
      height: 6px;
      background: #888;
      border-radius: 50%;
      animation: blink 1.4s infinite;
    }

    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }

    pre {
      background: #222;
      color: #eee;
      padding: 10px;
      border-radius: 10px;
      position: relative;
      overflow-x: auto;
      white-space: pre-wrap;
      margin: 5px 0;
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #444;
      color: #fff;
      border: none;
      padding: 5px 8px;
      font-size: 12px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body class="dark">
  <div class="toolbar">
    <button onclick="toggleTheme()">üåó Mode</button>
    <button onclick="clearChat()">üóëÔ∏è Clear</button>
  </div>

  <div id="chat" class="chat-container"></div>

  <div class="input-area">
    <div class="input-wrapper">
      <textarea id="input" placeholder="Napisz co≈õ..."></textarea>
      <button id="sendBtn" onclick="sendMessage()">Wy≈õlij</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");

    const aiAvatar = `<img src="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg" style="width:32px; height:32px;" />`;

    function generateUserAvatar() {
      const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26));
      const color = `hsl(${Math.random() * 360}, 60%, 40%)`;
      const textColor = `hsl(${Math.random() * 360}, 60%, 80%)`;
      return `<div class="avatar" style="background:${color};color:${textColor};">${letter}</div>`;
    }

    let userAvatar = generateUserAvatar();
    let messages = JSON.parse(localStorage.getItem("chat") || "[]");
    let isTyping = false;

    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    function clearChat() {
      messages = [];
      localStorage.removeItem("chat");
      chat.innerHTML = "";
    }

    function saveChat() {
      localStorage.setItem("chat", JSON.stringify(messages));
    }

    function formatMessage(content) {
      return content.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
        const escaped = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return `
          <pre><button class="copy-btn">üìã</button><code class="${lang}">${escaped}</code></pre>
        `;
      });
    }

    function renderMessage(content, sender) {
      const msg = document.createElement("div");
      msg.className = `message ${sender}`;
      const avatar = document.createElement("div");
      avatar.innerHTML = sender === "user" ? userAvatar : aiAvatar;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = sender === "ai" ? formatMessage(content) : content;
      msg.appendChild(avatar);
      msg.appendChild(bubble);
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }

    function showTyping() {
      const msg = document.createElement("div");
      msg.className = "message ai";
      const avatar = document.createElement("div");
      avatar.innerHTML = aiAvatar;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;
      msg.appendChild(avatar);
      msg.appendChild(bubble);
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
      return msg;
    }

    function typeWriter(el, fullText, cb) {
      let i = 0;
      el.textContent = '';
      isTyping = true;
      const interval = setInterval(() => {
        el.textContent += fullText[i++];
        chat.scrollTop = chat.scrollHeight;
        if (i >= fullText.length) {
          clearInterval(interval);
          el.innerHTML = formatMessage(fullText);
          document.dispatchEvent(new Event("rendered"));
          isTyping = false;
          cb && cb();
        }
      }, 15);
    }

    async function sendMessage() {
      if (isTyping) return;

      const question = input.value.trim();
      if (!question) return;
      input.value = "";

      renderMessage(question, "user");
      messages.push({ role: "user", content: question });
      saveChat();

      const loading = showTyping();

      try {
        const result = await puter.ai.chat(messages, { model: "gpt-4.1-mini" });
        const answer = result.message?.content || "‚ùå No response";
        messages.push({ role: "assistant", content: answer });
        saveChat();

        chat.removeChild(loading);
        const bubble = renderMessage("", "ai");
        typeWriter(bubble, answer);
      } catch (e) {
        console.error(e);
        chat.removeChild(loading);
        renderMessage("‚ùå Error communicating with AI.", "ai");
        isTyping = false;
      }
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("copy-btn")) {
        const code = e.target.nextElementSibling.innerText;
        navigator.clipboard.writeText(code).then(() => {
          e.target.textContent = "‚úÖ";
          setTimeout(() => (e.target.textContent = "üìã"), 2000);
        });
      }
    });

    messages.forEach((m) => renderMessage(m.content, m.role === "user" ? "user" : "ai"));
  </script>
</body>
</html>
