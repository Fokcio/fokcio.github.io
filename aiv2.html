<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat z AI</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root {
      --bg: #121212;
      --fg: #ffffff;
      --bubble-ai: #222;
      --bubble-user: #2e7d32;
      --sidebar-bg: #1e1e1e;
      --sidebar-border: #333;
      --accent: #4caf50;
    }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--sidebar-border);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 10px;
      border-bottom: 1px solid var(--sidebar-border);
      display: flex;
      gap: 6px;
    }

    .sidebar-header button {
      flex: 1;
      border: none;
      background: var(--accent);
      color: #fff;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    #searchChat {
      margin: 10px;
      padding: 8px;
      border-radius: 6px;
      border: none;
      width: calc(100% - 20px);
      background: #2a2a2a;
      color: white;
    }

    #chatList {
      flex: 1;
      overflow-y: auto;
    }

    .chat-item {
      padding: 10px;
      border-bottom: 1px solid var(--sidebar-border);
      cursor: pointer;
      position: relative;
    }

    .chat-item:hover {
      background: #2b2b2b;
    }

    .chat-name {
      font-weight: bold;
    }

    .chat-date {
      font-size: 12px;
      opacity: 0.6;
    }

    .chat-menu {
      position: absolute;
      right: 10px;
      top: 10px;
      display: none;
      flex-direction: column;
      background: #222;
      border: 1px solid #444;
      border-radius: 8px;
      overflow: hidden;
      z-index: 10;
    }

    .chat-menu button {
      background: none;
      border: none;
      color: white;
      padding: 8px 10px;
      cursor: pointer;
      text-align: left;
    }

    .chat-menu button:hover {
      background: #333;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      padding: 10px;
      border-bottom: 1px solid var(--sidebar-border);
      font-weight: bold;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      gap: 8px;
      max-width: 80%;
      word-break: break-word;
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .bubble {
      background: var(--bubble-ai);
      padding: 10px;
      border-radius: 15px;
      white-space: pre-wrap;
    }

    .user .bubble {
      background: var(--bubble-user);
    }

    .input-area {
      display: flex;
      padding: 10px;
      border-top: 1px solid var(--sidebar-border);
      gap: 10px;
    }

    #input {
      flex: 1;
      background: #222;
      border: none;
      border-radius: 10px;
      padding: 10px;
      color: white;
      resize: none;
      min-height: 40px;
    }

    #sendBtn {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      padding: 10px 15px;
    }

    pre {
      background: #1e1e1e;
      color: #e6e6e6;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      position: relative;
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #333;
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .typing {
      display: flex;
      gap: 5px;
    }

    .typing span {
      width: 6px;
      height: 6px;
      background: #888;
      border-radius: 50%;
      animation: blink 1.4s infinite;
    }

    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <button id="newChat">Nowy</button>
    </div>
    <input type="text" id="searchChat" placeholder="üîç Szukaj czatu...">
    <div id="chatList"></div>
  </div>

  <div class="main">
    <div class="toolbar" id="chatTitle">Chat AI</div>
    <div id="chat" class="chat-container"></div>
    <div class="input-area">
      <textarea id="input" placeholder="Napisz wiadomo≈õƒá..."></textarea>
      <button id="sendBtn">Wy≈õlij</button>
    </div>
  </div>

  <script>
    const chatContainer = document.getElementById('chat');
    const chatListEl = document.getElementById('chatList');
    const chatTitle = document.getElementById('chatTitle');
    const input = document.getElementById('input');

    const getChats = () => JSON.parse(localStorage.getItem('chats') || '{}');
    const saveChats = (data) => localStorage.setItem('chats', JSON.stringify(data));
    const generateID = () => 'chat-' + Math.random().toString(36).substr(2, 9);

    let chats = getChats();
    const params = new URLSearchParams(window.location.search);
    let chatID = params.get('chatID');

    if (!chatID || !chats[chatID]) {
      chatID = generateID();
      chats[chatID] = {
        name: 'Nowy czat',
        created: new Date().toISOString(),
        updated: new Date().toISOString(),
        messages: []
      };
      saveChats(chats);
      window.history.replaceState({}, '', `?chatID=${chatID}`);
    }

    let currentChat = chats[chatID];

    function renderChatList(filter = '') {
      chats = getChats();
      chatListEl.innerHTML = '';
      const entries = Object.entries(chats).sort((a, b) => new Date(b[1].updated) - new Date(a[1].updated));

      for (const [id, chat] of entries) {
        if (filter && !chat.name.toLowerCase().includes(filter.toLowerCase())) continue;

        const item = document.createElement('div');
        item.className = 'chat-item';
        item.innerHTML = `<div class="chat-name">${chat.name}</div>
                          <div class="chat-date">${new Date(chat.updated).toLocaleString()}</div>`;

        const menu = document.createElement('div');
        menu.className = 'chat-menu';
        menu.innerHTML = `
          <button onclick="renameChat('${id}')">‚úèÔ∏è Zmie≈Ñ nazwƒô</button>
          <button onclick="deleteChat('${id}')">üóëÔ∏è Usu≈Ñ</button>
        `;
        item.appendChild(menu);

        item.onclick = (e) => {
          if (e.target.tagName === 'BUTTON') return;
          window.location.href = \`?chatID=\${id}\`;
        };

        item.oncontextmenu = (e) => {
          e.preventDefault();
          document.querySelectorAll('.chat-menu').forEach(m => m.style.display = 'none');
          menu.style.display = 'flex';
        };

        chatListEl.appendChild(item);
      }
    }

    window.renameChat = function (id) {
      const newName = prompt('Nowa nazwa czatu:', chats[id].name);
      if (!newName) return;
      chats[id].name = newName;
      chats[id].updated = new Date().toISOString();
      saveChats(chats);
      renderChatList();
      if (id === chatID) chatTitle.textContent = chats[chatID].name;
    };

    window.deleteChat = function (id) {
      if (confirm('Czy na pewno chcesz usunƒÖƒá ten czat?')) {
        delete chats[id];
        saveChats(chats);
        renderChatList();
        if (id === chatID) {
          const firstChat = Object.keys(chats)[0];
          if (firstChat) window.location.href = \`?chatID=\${firstChat}\`;
          else {
            const newID = generateID();
            chats[newID] = { name: 'Nowy czat', created: new Date().toISOString(), updated: new Date().toISOString(), messages: [] };
            saveChats(chats);
            window.location.href = \`?chatID=\${newID}\`;
          }
        }
      }
    };

    document.getElementById('newChat').onclick = () => {
      const id = generateID();
      chats[id] = { name: 'Nowy czat', created: new Date().toISOString(), updated: new Date().toISOString(), messages: [] };
      saveChats(chats);
      renderChatList();
      window.location.href = \`?chatID=\${id}\`;
    };

    document.getElementById('searchChat').oninput = (e) => renderChatList(e.target.value);

    function formatMessage(content) {
      return content.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
        const escaped = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return \`<pre><button class="copy-btn">üìã</button><code class="language-\${lang}">\${escaped}</code></pre>\`;
      });
    }

    function renderMessage(content, sender) {
      const msg = document.createElement('div');
      msg.className = \`message \${sender}\`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = formatMessage(content);
      msg.appendChild(bubble);
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function renderAllMessages() {
      chatContainer.innerHTML = '';
      currentChat = getChats()[chatID];
      currentChat.messages.forEach(m => renderMessage(m.content, m.role));
      chatTitle.textContent = currentChat.name;
    }

    chatContainer.addEventListener('click', e => {
      if (e.target.classList.contains('copy-btn')) {
        const code = e.target.nextElementSibling.innerText;
        navigator.clipboard.writeText(code).then(() => {
          e.target.textContent = '‚úÖ';
          setTimeout(() => e.target.textContent = 'üìã', 2000);
        });
      }
    });

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      renderMessage(text, 'user');

      currentChat.messages.push({ role: 'user', content: text });
      currentChat.updated = new Date().toISOString();
      saveChats(chats);

      renderMessage('<div class="typing"><span></span><span></span><span></span></div>', 'ai');

      const res = await puter.ai.chat(currentChat.messages, { model: 'gpt-4o-mini' });
      const answer = res.message?.content || "Brak odpowiedzi od AI üòî";

      currentChat.messages.push({ role: 'assistant', content: answer });
      currentChat.updated = new Date().toISOString();
      saveChats(chats);
      renderAllMessages();
      renderChatList();
    }

    document.getElementById('sendBtn').onclick = sendMessage;
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    renderChatList();
    renderAllMessages();
  </script>
</body>
</html>
